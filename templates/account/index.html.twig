{% extends 'base.html.twig' %}
{% import 'macros/roles.twig' as roles_macros %}
{% import 'macros/appointment_macros.html.twig' as macros %}

{% block title %}Account
{% endblock %}

{% block stylesheets %}
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
{% endblock %}

{% block body %}
	<section class="account-page">
		<h2>My Account</h2>
		<div class="page-wrap">
			<div class="sidebar">
				<p>Welcome back,
					<span>{{ app.user.firstName }}</span>
				</p>
				<hr>
				<ul class="side-menu">
					<li class="active" data-target="personal-block">
						<a href="#" nofollow>Personal Information</a>
					</li>
					<li class="" data-target="history-block">
						<a href="#" nofollow>Visit history</a>
					</li>
					{% if is_granted('ROLE_ADMIN') %}
						<li data-target="appointments-block">
							<a href="#" nofollow>Appointments</a>
						</li>
						<li data-target="requests-block">
							<a href="#" nofollow>Requests</a>
						</li>
						<li data-target="users-block">
							<a href="#" nofollow>Users</a>
						</li>
					{% endif %}
					{% if is_granted('ROLE_SUPER_ADMIN') %}
						<li data-target="categories-block">
							<a href="#" nofollow>Treatments categories</a>
						</li>
					{% endif %}
				</ul>
				<hr>
				<a class="logout" href="{{ path('app_logout') }}">
					<img class="icon" src="{{ asset('media/icons/logOut.svg') }}" alt="Log Out">
					<span class="bottom_line_on_hover">Log Out</span>
				</a>
			</div>

			<div class="account-content">
				<div id="personal-block" class="account-block">
					<h3>Personal Information</h3>

					<p>
						Full name:
						<span id="fullname-container">
							<span id="fullname-text">{{ app.user.firstName }}
								{{ app.user.lastName }}</span>
							<button class="edit_button" id="edit-fullname-btn" type="button">
								<img class="icon" src="{{ asset('media/icons/edit.svg') }}" alt="Edit">
							</button>
						</span>
					</p>
					<form id="fullname-form" action="{{ path('app_edit_fullname') }}" method="post" class="hidden">
						<div class="field">
							<input type="text" name="firstName" value="{{ app.user.firstName }}" required minlength="2" maxlength="50" pattern="^[\p{L}\p{M}][\p{L}\p{M}\s'\-]{1,49}$" title="All allowed letters, spaces, apostrophes, and hyphens; from 2 to 50 characters" autocomplete="given-name">
							<span class="field-error" data-for="firstName" aria-live="polite"></span>
						</div>
						<div class="field">
							<input type="text" name="lastName" value="{{ app.user.lastName }}" required minlength="2" maxlength="50" pattern="^[\p{L}\p{M}][\p{L}\p{M}\s'\-]{1,49}$" title="All allowed letters, spaces, apostrophes, and hyphens; from 2 to 50 characters" autocomplete="family-name">
							<span class="field-error" data-for="lastName" aria-live="polite"></span>
						</div>
						<button type="submit" class="edit_button done" data-loading="false">&#10003;</button>
					</form>

					<p>Email:
						{{ app.user.email }}
						<a href="{{ path('app_change_email') }}">Change email</a>
					</p>

					<p>
						Phone number:
						<span id="phone-container" {% if not app.user.phone %} style="display:none;" {% endif %}>
							<span id="phone-text">{{ app.user.phone ?? '' }}</span>
							<button class="edit_button" id="edit-phone-btn" type="button">
								<img class="icon" src="{{ asset('media/icons/edit.svg') }}" alt="Edit">
							</button>
						</span>
					</p>
					<form id="phone-form" action="{{ path('app_edit_phone') }}" method="post" {% if app.user.phone %} class="hidden" {% endif %}>
						<div class="field">
							<input type="tel" name="phone" value="{{ app.user.phone ?? '' }}" placeholder="+44 7XXX XXX XXX" required inputmode="tel" pattern="^\+44\s?7\d{3}\s?\d{3}\s?\d{3}$" title="Enter your phone number in the format +44 7XXX XXX XXX" autocomplete="tel">
							<span class="field-error" data-for="phone" aria-live="polite"></span>
						</div>
						<button type="submit" class="edit_button done" data-loading="false">&#10003;</button>
					</form>

					<p>
						<a href="{{ path('app_change_password') }}">Change password</a>
					</p>
				</div>

				<div id="history-block" style="display:none;" class="account-block" data-controller="visit-history">
					<h3>Visit History</h3>
					<div class="timeline" data-visit-history-target="timeline"></div>
					<button type="button" class="transparent_black_button" data-visit-history-target="loadMore" data-action="visit-history#load">
						Load more
					</button>
				</div>

				{% if is_granted('ROLE_ADMIN') %}
					<div id="appointments-block" style="display:none;" class="account-block">
						<h3>Appointments</h3>
						<button type="button" class="create_button" onclick="window.open('{{ path('appointment_new') }}', '_blank')">
							Create Appointment +
						</button>
						<table id="appointments-table" class="display">
							<thead>
								<tr>
									<th>â„–</th>
									<th>Date</th>
									<th>Full Name</th>
									<th>Phone</th>
									<th>Doctor</th>
									<th>Treatment</th>
									<th>Status</th>
									<th>Info</th>
								</tr>
							</thead>
							<tbody>
								{% for appointment in appointments %}
									<tr>
										<td>{{ appointment.id }}</td>
										{{ macros.statusCell(appointment) }}
										<td>
											{{
												appointment.user
													? appointment.user.lastName ~ ' ' ~ appointment.user.firstName ~ ', ' ~ appointment.user.id
													: appointment.guestContact
														? appointment.guestContact.name ~ ', Guest'
														: 'Unknown'
											}}
										</td>
										<td>
											{{
												appointment.user
													? (appointment.user.phone ? appointment.user.phone : 'Not set by user')
													: (appointment.guestContact ? appointment.guestContact.phone : 'Unknown')
											}}
										</td>
										<td>{{ appointment.doctor ? appointment.doctor : 'Not set' }}</td>
										<td>{{ appointment.treatment ? appointment.treatment.name : 'Not set' }}</td>
										<td>
											<select class="appointment-status-select colored-select {{ appointment.status }}" data-appointment-id="{{ appointment.id }}" {% if appointment.status == 'completed' %} disabled {% endif %}>
												<option class="scheduled" value="scheduled" {{ 'scheduled' in appointment.status ? 'selected' : '' }}>Scheduled</option>
												<option class="no_show" value="no_show" {{ 'no_show' in appointment.status ? 'selected' : '' }}>No Show</option>
												<option class="completed" value="completed" {{ 'completed' in appointment.status ? 'selected' : '' }}>Completed</option>
												<option class="cancelled" value="cancelled" {{ 'cancelled' in appointment.status ? 'selected' : '' }}>Cancelled</option>
												<option class="created_by_mistake" value="created_by_mistake" {{ 'created_by_mistake' in appointment.status ? 'selected' : '' }}>Created by Mistake</option>
											</select>
										</td>
										<td>
											<button class="transparent_black_button" data-controller="appointment-details" data-action="click->appointment-details#show" data-appointment-id="{{ appointment.id }}">
												Details
											</button>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<div id="requests-block" style="display:none;" class="account-block">
						<h3>Appointment & Consultation requests</h3>
						<table id="requests-table" class="display">
							<thead>
								<tr>
									<th>Date</th>
									<th>Type</th>
									<th>Full Name</th>
									<th>Phone</th>
									<th>Treatment</th>
									<th>Status</th>
									<th>Info</th>
								</tr>
							</thead>
							<tbody>
								{% for request in appointmentRequests %}
									<tr>
										<td>{{ request.createdAt ? request.createdAt|date('d/m/Y') : '' }}</td>
										<td>{{ request.question ? 'Consultation' : 'Appointment' }}</td>
										<td>{{ request.name ~ (request.user ? '' : '/Guest') }}</td>
										<td>{{ request.phone ?: 'Not set' }}</td>
										<td>{{ request.treatment ? request.treatment.name : 'Not set' }}</td>
										<td>
											<select class="request-status-select colored-select {{ request.status }}" data-request-id="{{ request.id }}" {% if request.status == 'confirmed' %} disabled {% endif %}>
												<option class="created" value="created" {{ 'created' in request.status ? 'selected' : '' }}>Created</option>
												<option class="in_progress" value="in_progress" {{ 'in_progress' in request.status ? 'selected' : '' }}>In Progress</option>
												<option class="confirmed" value="confirmed" {{ 'confirmed' in request.status ? 'selected' : '' }}>Confirmed</option>
												<option class="no_answer" value="no_answer" {{ 'no_answer' in request.status ? 'selected' : '' }}>No Answer</option>
												<option class="cancelled" value="cancelled" {{ 'cancelled' in request.status ? 'selected' : '' }}>Cancelled</option>
												<option class="processed" value="processed" {{ 'processed' in request.status ? 'selected' : '' }}>Processed</option>
											</select>
										</td>
										<td>
											<button class="transparent_black_button" data-controller="request-details" data-action="click->request-details#show" data-request-id="{{ request.id }}">
												Details
											</button>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<div id="users-block" style="display:none;" class="account-block">
						<h3>Users</h3>
						<table id="users-table" class="display">
							<thead>
								<tr>
									<th>ID</th>
									<th>Email</th>
									<th>Full Name</th>
									<th>Phone</th>
									<th>Roles</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody>
								{% for user in users %}
									<tr>
										<td>{{ user.id }}</td>
										<td>{{ user.email }}</td>
										<td>{{ user.firstName }}
											{{ user.lastName }}</td>
										<td>{{ user.phone ?: 'Not set' }}</td>
										<td>
											{% if 'ROLE_SUPER_ADMIN' in app.user.roles %}
												<select class="user-role-select" data-user-id="{{ user.id }}">
													<option value="ROLE_USER" {{ 'ROLE_USER' in user.roles ? 'selected' : '' }}>User</option>
													<option value="ROLE_ADMIN" {{ 'ROLE_ADMIN' in user.roles ? 'selected' : '' }}>Manager</option>
													<option value="ROLE_SUPER_ADMIN" {{ 'ROLE_SUPER_ADMIN' in user.roles ? 'selected' : '' }}>Admin</option>
												</select>
											{% else %}
												{{ roles_macros.main_role(user.roles) }}
											{% endif %}
										</td>
										<td>
											{% if 'ROLE_SUPER_ADMIN' in app.user.roles %}
												<input data-user-id="{{ user.id }}" type="checkbox" class="user-active-checkbox" {% if user.isActive %} checked {% endif %} title="Toggle active">
											{% else %}
												{{ user.isActive ? 'Active' : 'Inactive' }}
											{% endif %}
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				{% endif %}
				{% if is_granted('ROLE_SUPER_ADMIN') %}
					<div id="categories-block" style="display:none;" class="account-block">
						<h3>Categories</h3>
						<button type="button" class="create_button" id="create-category-btn">
							Create Category +
						</button>
						<table id="categories-table" class="display">
							<thead>
								<tr>
									<th>Name</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for category in treatmentsCategories %}
									<tr>
										<td>
											<input class="category-name" data-category-id="{{ category.id }}" type="text" value="{{ category.name }}">
										</td>
										<td>
											<button class="edit_button delete-button" type="button" data-category-id="{{ category.id }}">
												<img class="icon" src="{{ asset('media/icons/delete.svg') }}" alt="Delete">
											</button>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<div id="modal-forms" style="display:none;">
						<div id="category-form-template">
							{% include 'modals/_category_form.html.twig' %}
						</div>
					</div>
				{% endif %}
			</div>
		</div>
	</section>
{% endblock %}

{% block javascripts %}
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	<script src="{{ asset('js/account.js') }}"></script>
{% endblock %}
